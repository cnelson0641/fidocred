.setup_env_template:
    before_script:
        - bash ci_env_vars.sh

.build_template:
    extends:
        - .setup_env_template
    stage: build
    image: docker:25.0.3
    services:
        - docker:25.0.3-dind
    variables:
        DOCKER_HOST: tcp://docker:2375/
        DOCKER_TLS_CERTDIR: ""
    before_script:
        - '[ -z "$AWS_ACCESS_KEY_ID" ] && echo "Missing AWS_ACCESS_KEY_ID" && exit 1'
        - '[ -z "$AWS_SECRET_ACCESS_KEY" ] && echo "Missing AWS_SECRET_ACCESS_KEY" && exit 1'
        - '[ -z "$AWS_REGION" ] && echo "Missing AWS_REGION" && exit 1'
        - '[ -z "$GITLAB_ENV" ] && echo "Missing GITLAB_ENV" && exit 1'
        - apk add --no-cache bash zip
    script:
        - bash util/zip_lambda.sh
    artifacts:
        paths:
            - artifacts/lambda.zip
        expire_in: 1h

.validate_network_template:
    extends:
        - .setup_env_template
    stage: validate
    image:
        name: oowy/opentofu:1.9.1-alpine3.20
    script:
        - cd infra/network
        - tofu init $TF_BACKEND_CONFIG $TF_BACKEND_KEY_NETWORK
        - tofu validate $TF_NETWORK_VARS

.validate_db_template:
    extends:
        - .setup_env_template
    stage: validate
    image:
        name: oowy/opentofu:1.9.1-alpine3.20
    script:
        - cd infra/db
        - tofu init $TF_BACKEND_CONFIG $TF_BACKEND_KEY_DB
        - tofu validate $TF_DB_VARS

.validate_app_template:
    extends:
        - .setup_env_template
    stage: validate
    image:
        name: oowy/opentofu:1.9.1-alpine3.20
    script:
        - cd infra/app
        - tofu init $TF_BACKEND_CONFIG $TF_BACKEND_KEY_APP
        - tofu validate $TF_APP_VARS

.plan_network_template:
    extends:
        - .setup_env_template
    stage: plan
    image:
        name: oowy/opentofu:1.9.1-alpine3.20
    script:
        - cd infra/network
        - tofu init $TF_BACKEND_CONFIG $TF_BACKEND_KEY_NETWORK
        - echo ${GITLAB_ENV} ${CI_ENVIRONMENT_NAME}
        - tofu plan -out="../../artifacts/${GITLAB_ENV}-network.tfplan" $TF_NETWORK_VARS
    artifacts:
        paths:
            - "artifacts/${GITLAB_ENV}-network.tfplan"
        expire_in: 6 hours

.plan_db_template:
    extends:
        - .setup_env_template
    stage: plan
    image:
        name: oowy/opentofu:1.9.1-alpine3.20
    script:
        - cd infra/db
        - tofu init $TF_BACKEND_CONFIG $TF_BACKEND_KEY_DB
        - tofu plan -out="../../artifacts/${GITLAB_ENV}-db.tfplan" $TF_DB_VARS
    artifacts:
        paths:
            - "artifacts/${GITLAB_ENV}-db.tfplan"
        expire_in: 6 hours

.plan_app_template:
    extends:
        - .setup_env_template
    stage: plan
    image:
        name: oowy/opentofu:1.9.1-alpine3.20
    script:
        - cd infra/app
        - tofu init $TF_BACKEND_CONFIG $TF_BACKEND_KEY_APP
        - tofu plan -out="../../artifacts/${GITLAB_ENV}-app.tfplan" $TF_APP_VARS
    artifacts:
        paths:
            - "artifacts/${GITLAB_ENV}-app.tfplan"
        expire_in: 6 hours

.apply_network_template:
    extends:
        - .setup_env_template
    stage: apply
    image:
        name: oowy/opentofu:1.9.1-alpine3.20
    script:
        - cd infra/network
        - tofu init $TF_BACKEND_CONFIG $TF_BACKEND_KEY_NETWORK
        - tofu apply "../../artifacts/${GITLAB_ENV}-network.tfplan"

.apply_db_template:
    extends:
        - .setup_env_template
    stage: apply
    image:
        name: oowy/opentofu:1.9.1-alpine3.20
    script:
        - cd infra/db
        - tofu init $TF_BACKEND_CONFIG $TF_BACKEND_KEY_DB
        - tofu apply "../../artifacts/${GITLAB_ENV}-db.tfplan"

.apply_app_template:
    extends:
        - .setup_env_template
    stage: apply
    image:
        name: oowy/opentofu:1.9.1-alpine3.20
    script:
        - cd infra/app
        - tofu init $TF_BACKEND_CONFIG $TF_BACKEND_KEY_APP
        - tofu apply "../../artifacts/${GITLAB_ENV}-app.tfplan"


#TODO
.db_setup_template:
    extends:
        - .setup_env_template
    stage: apply
    image: postgres:15
    variables:
        DB_HOST: $DB_HOST
        DB_PORT: $DB_PORT
        DB_USER: $DB_USER
        DB_PASS: $DB_PASS
        DB_NAME: $DB_NAME
    script:
        - echo "Running schema.sql..."
        - PGPASSWORD="$DB_PASS" psql -h "$DB_HOST" -U "$DB_USER" -d "$DB_NAME" -f infra/db/schema.sql
        - echo "Running _seed_dummy_data.sql..."
        - PGPASSWORD="$DB_PASS" psql -h "$DB_HOST" -U "$DB_USER" -d "$DB_NAME" -f infra/db/_seed_dummy_data.sql
    rules:
        - if: '$DB_HOST && $DB_USER && $DB_PASS && $DB_NAME'

.plan_template:
    stage: plan
    image:
        name: hashicorp/terraform:1.6.0
        entrypoint: [""]
    environment:
        name: $ENV
    before_script:
        - pwd
        - ls -al
        - terraform --version
    script:
        - cd infra
        - terraform init -backend-config="path=backend-${ENV}.tfstate"
        - terraform plan -out="${ENV}.tfplan"
    artifacts:
        paths:
            - "${ENV}.tfplan"
        expire_in: 6 hours

.apply_template:
    stage: apply
    image:
        name: hashicorp/terraform:1.6.0
        entrypoint: [""]
    environment:
        name: $ENV
    script:
        - cd infra
        - terraform apply "${ENV}.tfplan"

.build_template:
    stage: build
    image: docker:25.0.3
    services:
        - docker:25.0.3-dind
    variables:
        DOCKER_HOST: tcp://docker:2375/
        DOCKER_TLS_CERTDIR: ""
    before_script:
        - '[ -z "$AWS_ACCESS_KEY_ID" ] && echo "Missing AWS_ACCESS_KEY_ID" && exit 1'
        - '[ -z "$AWS_SECRET_ACCESS_KEY" ] && echo "Missing AWS_SECRET_ACCESS_KEY" && exit 1'
        - '[ -z "$AWS_REGION" ] && echo "Missing AWS_REGION" && exit 1'
        - '[ -z "$gitlab_env" ] && echo "Missing gitlab_env" && exit 1'
        - apk add --no-cache bash zip
    script:
        - bash util/zip_lambda.sh
    artifacts:
        paths:
            - artifacts/lambda.zip
        expire_in: 1h

.validate_template:
    stage: validate
    image:
        name: oowy/opentofu:1.9.1-alpine3.20
    script:
        - cd infra
        - tofu init -backend-config="$OT_BACKEND_CONFIG"
        - tofu validate
    artifacts:
        paths:
            - artifacts/lambda.zip
        expire_in: 1h


.plan_template:
    stage: plan
    image:
        name: oowy/opentofu:1.9.1-alpine3.20
    script:
        - cd infra
        - echo ${OT_BACKEND_CONFIG}
        - tofu init -backend-config="${OT_BACKEND_CONFIG}"
        - tofu plan -out="../artifacts/${gitlab_env}.tfplan" -var="gitlab_env=${gitlab_env}"
    artifacts:
        paths:
            - "artifacts/${gitlab_env}.tfplan"
        expire_in: 6 hours

.apply_template:
    stage: apply
    image:
        name: oowy/opentofu:1.9.1-alpine3.20
    script:
        - cd infra
        - tofu init -backend-config="$OT_BACKEND_CONFIG"
        - tofu apply "../artifacts/${gitlab_env}.tfplan"

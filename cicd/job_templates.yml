.build_template:
    stage: build
    image: docker:25.0.13
    services:
        - docker:25.0.13-dind
    variables:
        DOCKER_HOST: tcp://docker:2375/
        DOCKER_TLS_CERTDIR: ""
    before_script:
        - apk add --no-cache bash zip
    script:
        - bash util/zip_lambda.sh
    artifacts:
        paths:
            - artifacts/lambda.zip
        expire_in: 1h

.validate_template:
    stage: validate
    image:
        name: oowy/opentofu:1.9.1-alpine3.20
    environment:
        name: $ENV
    script:
        - cd infra
        - tofu init
        - tofu validate
    artifacts:
        paths:
            - artifacts/lambda.zip
        expire_in: 1h   # keep it short, just for pipeline


.plan_template:
    stage: plan
    image:
        name: oowy/opentofu:1.9.1-alpine3.20
    environment:
        name: $ENV
    script:
        - cd infra
        - tofu init
        - tofu plan -out="${ENV}.tfplan" -var="env_name=${ENV}"
    artifacts:
        paths:
            - "${ENV}.tfplan"
        expire_in: 6 hours

.apply_template:
    stage: apply
    image:
        name: oowy/opentofu:1.9.1-alpine3.20
    environment:
        name: $ENV
    script:
        - cd infra
        - tofu init
        - tofu apply "${ENV}.tfplan"
